@extends('layouts.master')

@section('title')
    اضافة عدد
@endsection

@section('stylesheets')

@endsection

@section('content')

    <!-- start content-wrapper -->
    <div class="content-wrapper">
        <div class="main_content">

            <!-- start row -->
            <div class="row align-items-center min-height-row">
                <div class="col-lg-6">
                    <div class="d-flex align-items-center flex-wrap">
                        <ol class="breadcrumb">
                            <li><a href="#">الرئيسية</a></li>
                            <li>الكويت اليوم</li>
                            <li><a href="#">اضافة عدد</a></li>
                        </ol>
                    </div>
                </div>
                <div class="col-lg-6">
                </div>
            </div>
            <!-- end row -->
            <!-- start row -->
            <div class="row mt-0">
                <div class="col-lg-12 tbl-new-brdr">
                    <div class="panel panel-default no-brdr">

                        <form action="{{route('saveVersion')}}" method="POST" enctype="multipart/form-data">
                            @csrf
                            <div class="col-md-6 float-right">
                                <div class="form-row">
                                    <div class="form-group col-md-6">
                                        <label>نوع الإصدار</label>
                                        <select name="versionType" id="versionType" dir="rtl" class="SelectWithSearch"
                                                required>
                                            <option dir="rtl" value="عدد اساسى">عدد اساسى</option>
                                            <option dir="rtl" value="ملحق">ملحق</option>
                                        </select>
                                    </div>
                                    <div class="form-group col-md-6">
                                        <label>رقم العدد</label>
                                        <input type="num" name="versionNo" id="versionNo" lang="en" class="form-control"
                                               placeholder=" رقم العدد" required {{old('versionNo')}} dir="rtl">
                                    </div>

                                    <div class="form-group col-md-6">
                                        <label>تاريخ النشر بالجريدة الرسمية</label>
                                        <input type="date" class="form-control" name="versionDate" id="versionDate"
                                               {{old('versionDate')}} required>
                                    </div>
                                </div>
                                @if ($files)
                                    <button type="submit" data-dismiss="modal" class="btn general_btn btn_1">حفظ
                                    </button>
                                    <a href="{{route('KuwaitAlyoum')}}" data-dismiss="modal"
                                       class="btn general_btn btn_1">العودة</a>
                                @else
                                    <a href="{{route('KuwaitAlyoum')}}" data-dismiss="modal"
                                       class="btn general_btn btn_1">العودة</a>
                                @endif
                                @if ($lastVersion)
                                    <a href="{{route('updateLastVersion',['lastVersion'=>$lastVersion])}}"
                                       class="btn general_btn btn_1"
                                    >
                                        تعديل الإدخال الأخير
                                    </a>

                                @endif

                            </div>
                            <div class="col-md-6 float-right overflow-auto" style="height: 650px;overflow-y: scroll;">
                                <iframe id="myFrame" style="display:none" width="100%" height="400"></iframe>
                                <div class="radio">
                                    @foreach ($files as $fileName)
                                        <label>
                                            <input type="radio"
                                                   onclick="openPdf({{json_encode($fileName)}})" name="versionFile"
                                                   id="versionFile" value="{{$fileName}}" required>
                                            {{$fileName}}
                                        </label>
                                    @endforeach
                            </div>

                        </form>

                    </div>
                </div>
            </div>
            <!-- end row -->
        </div>
    </div>
    <!-- end content-wrapper -->

@endsection

@section('secripts')
    <script type="text/javascript">
        function openPdf(file) {
            var omyFrame = document.getElementById("myFrame");
            omyFrame.style.display = "block";
            let filename = "/storage/KuwaitAlyoum_unfinished/" + file;
            omyFrame.src = filename;
        }
    </script>
@endsection


<?php

namespace App\Http\Controllers;

use Illuminate\Http\Request;
use App\Models\KuwaiToday;
use Illuminate\Support\Facades\Storage;
use Session;

class KuwaiTodayController extends Controller
{
    public function index()
    {
        return view('kuwaiToday.index');
    }

    public function KuwaitAlyoumList()
    {
        $versions = KuwaiToday::all();
        return datatables()->of($versions)->make(true);
    }

    public function create($lastVersion = null)
    {
        $files = KuwaiTodayController::readDirectory('/public/KuwaitAlyoum_unfinished/');
        if ($lastVersion) {
            $lastVersion = KuwaiToday::find($lastVersion);
        }
        return view('kuwaiToday.create', compact(['files'], 'lastVersion'));
    }

    public function store(Request $request)
    {
        dd($request->toArray());
        $this->validate($request,
            [
                'versionNo' => 'required|unique:kuwai_todays',
                'versionType' => 'required',
                'versionDate' => 'required',
                'versionFile' => 'required|unique:kuwai_todays',
            ], [  // change the default english error validation messages with arabic ones
                'versionNo.required' => 'مطلوب إدخال رقم العدد',
                'versionNo.unique' => 'ملف هذا العدد موجود بالفعل',
                'versionType.required' => 'مطلوب إخال نوع العدد',
                'versionDate.required' => 'مطلوب إدخال تاريخ العدد',
                'versionFile.required' => 'مطلوب إدخال مستند العدد ',
                'versionFile.unique' => 'مستند العدد موجود بالفعل',
            ]);

        if (!(Storage::exists('public/KuwaitAlyoum_finished/' . $request->versionFile))) {
            $fileToSave = ($request->versionNo) . '.' . 'pdf';
            $path = Storage::move(('/public/KuwaitAlyoum_unfinished/' . $request->versionFile), ('public/KuwaitAlyoum_finished/' . $fileToSave));
            $lastVersion = KuwaiToday::create([
                'versionno' => $request->versionNo,
                'versiontype' => $request->versionType,
                'versiondate' => $request->versionDate,
                'versionfile' => $fileToSave,
            ]);
            if ($lastVersion) {
                Session::put('notification', [
                    'message' => " تم إضافة العدد بنجاح ",
                    'alert-type' => 'success',
                ]);
                return redirect()->route('addVersion', ['lastVersion' => $lastVersion]);
            }
        } else {
            Session::put('notification', [
                'message' => " خطأ العدد موجود بالفعل ",
                'alert-type' => 'error',
            ]);
            return back();
        }
    }
    public function show(KuwaiToday $version)
    {
        return $version;
    }

    public function updateLastInput(KuwaiToday $lastVersion)
    {
        return view('kuwaiToday.updateLastInput', compact('lastVersion'));
    }

    public function saveLastInput(Request $request, KuwaiToday $lastVersion)
    {
        $this->validate($request,
            [
                'versionNo' => 'required',
                'versionType' => 'required',
                'versionDate' => 'required',
            ], [  // change the default english error validation messages with arabic ones
                'versionNo.required' => 'مطلوب إدخال رقم العدد',
                'versionType.required' => 'مطلوب إخال نوع العدد',
                'versionDate.required' => 'مطلوب إدخال تاريخ العدد',
            ]);
        $updatedFilename = ($request->versionNo . '.' . 'pdf');
        if ($request->versionNo != $lastVersion->versionno) {
            $path = Storage::move(('/public/KuwaitAlyoum_finished/' . $lastVersion->versionfile), ('public/KuwaitAlyoum_finished/' . $updatedFilename));
            $lastVersion->versionfile = $updatedFilename;
        }
        $lastVersion->versionno = $request->versionNo;
        $lastVersion->versiontype = $request->versionType;
        $lastVersion->versiondate = $request->versionDate;
        $lastVersion->save();
        Session::put('notification', [
            'message' => " تم إضافة العدد بنجاح ",
            'alert-type' => 'success',
        ]);
        return redirect()->route('addVersion', ['lastVersion' => $lastVersion]);
    }

    public static function readDirectory($directory)
    {
        $files = array_filter(Storage::disk('local')->files($directory),
            function ($item) {
                return strpos($item, 'pdf');
            });
        $realfilesName = [];
        foreach ($files as $file) {
            $data = explode("/", $file);
            $realfilesName [] = $data[2];
        }
        return $realfilesName;

    }


}
